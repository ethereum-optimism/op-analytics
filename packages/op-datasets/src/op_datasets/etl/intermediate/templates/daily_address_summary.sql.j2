WITH

projected_blocks AS (
  SELECT
    number,
    base_fee_per_gas
  FROM
    blocks
),

projected_transactions AS (
  SELECT
    -- Transaction fields
    t.dt,
    t.chain,
    t.chain_id,
    t.nonce,
    t.from_address,
    t.to_address,
    t.block_number,
    t.block_timestamp,
    t.receipt_status = 1 AS success,
    epoch_to_hour(t.block_timestamp) AS block_hour,
    substring(t.input, 1, 10) AS method_id,
    -- Receipt Gas Fields
    t.receipt_gas_used,
    t.receipt_l1_gas_used
    -- Calculations
    {% for projection in transaction_calculations %}
    , {{ projection.aliased }}
    {% endfor -%}
  FROM transactions AS t
  INNER JOIN projected_blocks AS b ON t.block_number = b.number
  WHERE
    t.gas_price > 0
    -- Optional address filter for faster results when developing.
    -- AND from_address LIKE '0x00%'
)

SELECT
  dt,
  chain,
  chain_id,
  from_address AS address,
  -- Aggregates

  count(*) AS total_txs,

  count(if(success, 1, NULL)) AS total_txs_success,

  count(DISTINCT block_number) AS total_blocks,

  count(DISTINCT if(success, block_number, NULL)) AS total_blocks_success,

  min(block_number) AS min_block_number,

  max(block_number) AS max_block_number,

  max(block_number) - min(block_number) + 1 AS block_interval_active,

  min(nonce) AS min_nonce,

  max(nonce) AS max_nonce,

  max(nonce) - min(nonce) + 1 AS nonce_interval_active,

  min(block_timestamp) AS min_block_timestamp,

  max(block_timestamp) AS max_block_timestamp,

  max(block_timestamp) - min(block_timestamp) AS time_interval_active,

  count(DISTINCT block_hour) AS unique_hours_active,

  count(DISTINCT to_address) AS num_to_addresses,

  count(DISTINCT if(success, to_address, NULL)) AS num_to_addresses_success,

  count(DISTINCT method_id) AS num_method_ids,

  sum(receipt_gas_used) AS total_l2_gas_used,

  sum(if(success, receipt_gas_used, 0)) AS total_l2_gas_used_success,

  sum(coalesce(receipt_l1_gas_used, l1_estimated_gas_used))
    AS total_l1_gas_used,

  sum(if(success, coalesce(receipt_l1_gas_used, l1_estimated_gas_used), 0))
    AS total_l1_gas_used_success,

  wei_to_eth(sum(total_fee)) AS total_gas_fees,

  wei_to_eth(sum(if(success, total_fee, 0))) AS total_gas_fees_success,

  wei_to_eth(sum(l2_fee)) AS l2_contrib_gas_fees,

  wei_to_eth(sum(l1_fee)) AS l1_contrib_gas_fees,

  wei_to_eth(sum(l1_blob)) AS l1_contrib_contrib_gas_fees_blobgas,

  wei_to_eth(sum(l1_base)) AS l1_contrib_gas_fees_l1gas,

  wei_to_eth(sum(l2_base)) AS l2_contrib_gas_fees_basefee,

  wei_to_eth(sum(l2_priority)) AS l2_contrib_gas_fees_priorityfee,

  wei_to_eth(sum(l2_base_legacy)) AS l2_contrib_gas_fees_legacyfee,

  wei_to_gwei(safe_div(sum(l2_fee), sum(receipt_gas_used)))
    AS avg_l2_gas_price_gwei,

  wei_to_gwei(safe_div(sum(l2_base), sum(receipt_gas_used)))
    AS avg_l2_base_fee_gwei,

  wei_to_gwei(safe_div(sum(l2_priority), sum(receipt_gas_used)))
    AS avg_l2_priority_fee_gwei,

  wei_to_gwei(
    safe_div(
      sum(l1_estimated_size * l1_base_scaled_price),
      sum(l1_estimated_size * l1_base_scalar)
    )
  ) AS avg_l1_gas_price_gwei,

  wei_to_gwei(
    safe_div(
      sum(l1_estimated_size * l1_blob_scaled_price),
      sum(l1_estimated_size * l1_blob_scalar)
    )
  ) AS avg_l1_blob_base_fee_gwei
FROM
  projected_transactions
GROUP BY
  1,
  2,
  3,
  4
