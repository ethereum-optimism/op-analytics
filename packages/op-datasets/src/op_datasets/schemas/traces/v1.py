"""
TRACES SCHEMA
"""

from textwrap import dedent

from pyiceberg.types import LongType, StringType, TimestampType

from op_datasets.schemas import shared
from op_datasets.schemas.core import Column, CoreDataset

TRACES_V1_SCHEMA = CoreDataset(
    name="traces_v1",
    goldsky_table="traces",
    block_number_col="block_number",
    doc=dedent("""Indexed Traces."""),
    columns=[
        shared.METADATA(field_id=1),
        shared.CHAIN(field_id=2),
        shared.NETWORK(field_id=3),
        shared.CHAIN_ID(field_id=4),
        # Block
        Column(
            field_id=5,
            name="block_timestamp",
            field_type=TimestampType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="block_timestamp",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="block_timestamp",
        ),
        Column(
            field_id=6,
            name="block_number",
            field_type=LongType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="block_number",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(block_number, 'Int64') AS block_number",
        ),
        Column(
            field_id=7,
            name="block_hash",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="block_hash",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="cast(block_hash, 'String') AS block_hash",
        ),
        # Transaction
        Column(
            field_id=8,
            name="transaction_hash",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="transaction_hash",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="cast(transaction_hash, 'String') AS transaction_hash",
        ),
        Column(
            field_id=9,
            name="transaction_index",
            field_type=LongType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="transaction_index",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(transaction_index, 'Int64') AS transaction_index",
        ),
        Column(
            field_id=10,
            name="from_address",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="from_address",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="cast(from_address, 'String') AS from_address",
        ),
        Column(
            field_id=11,
            name="to_address",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="to_address",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="cast(to_address, 'String') AS to_address",
        ),
        Column(
            field_id=12,
            name="value_64",
            field_type=LongType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="value",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCastOrNull(value, 'Int64') AS value_64",
            doc="Lossy value downcasted to Int64 to be compatible with BigQuery data types.",
        ),
        Column(
            field_id=13,
            name="value_lossless",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="value",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="cast(value, 'String') AS value_lossless",
        ),
        Column(
            field_id=14,
            name="input",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="input",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="input",
        ),
        Column(
            field_id=15,
            name="output",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="output",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="output",
        ),
        # Trace
        Column(
            field_id=16,
            name="trace_type",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="trace_type",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="cast(trace_type, 'String') AS trace_type",
        ),
        Column(
            field_id=17,
            name="call_type",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="call_type",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="cast(call_type, 'String') AS call_type",
        ),
        Column(
            field_id=18,
            name="reward_type",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="reward_type",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="cast(reward_type, 'String') AS reward_type",
        ),
        Column(
            field_id=19,
            name="gas",
            field_type=LongType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="gas",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(gas, 'Int64') AS gas",
        ),
        Column(
            field_id=20,
            name="gas_used",
            field_type=LongType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="gas_used",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(gas_used, 'Int64') AS gas_used",
        ),
        Column(
            field_id=21,
            name="subtraces",
            field_type=LongType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="subtraces",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(subtraces, 'Int64') AS subtraces",
        ),
        Column(
            field_id=22,
            name="trace_address",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="trace_address",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="cast(trace_address, 'String') AS trace_address",
        ),
        Column(
            field_id=23,
            name="error",
            field_type=StringType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="error",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="cast(error, 'String') AS error",
        ),
        Column(
            field_id=24,
            name="status",
            field_type=LongType(),
            required=True,
            json_rpc_method=None,
            json_rpc_field_name=None,
            raw_goldsky_pipeline_expr="status",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(status, 'Int64') AS status",
        ),
    ],
)
