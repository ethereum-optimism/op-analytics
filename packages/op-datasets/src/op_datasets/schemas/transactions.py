"""
TRANSACTIONS SCHEMA
"""

from textwrap import dedent

from pyiceberg.types import DoubleType, IntegerType, ListType, LongType, StringType, TimestampType

from op_datasets import shared
from op_datasets.core import Column, JsonRPCMethod, Table

TRANSACTIONS_SCHEMA = Table(
    name="transactions",
    doc=dedent("""Indexed Transactions. See [eth_gettransactionreceipt](https://ethereum.org/en/developers/docs/apis/json-rpc/#eth_gettransactionreceipt) for more info.
    
    Fields from RPC not included here:
    - eth_getTransactionByHash.blobVersionedHashes
    
    Fields from OP Labs pipeline sink tables not included here:
    - gateway_fee
    - gateway_fee_recipient
    - fee_currency
    - receipt_l1_block_number
    
    
    For more information on transaction fields return by RPC see the implementation on the 
    [op-geth repo](https://github.com/ethereum-optimism/op-geth/blob/c283254e5447f127e3b9350860985911dab9cd2f/internal/ethapi/api.go#L1453).
    
    """),
    columns=[
        shared.INGESTION_METADATA(field_id=1),
        shared.CHAIN(field_id=2),
        shared.NETWORK(field_id=3),
        shared.CHAIN_ID(field_id=4),
        # Block
        Column(
            field_id=5,
            name="block_timestamp",
            field_type=TimestampType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getBlockByNumber,
            json_rpc_field_name="timestamp",
            raw_goldsky_pipeline_expr="block_timestamp",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="block_timestamp",
        ),
        Column(
            field_id=6,
            name="block_number",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getBlockByNumber,
            json_rpc_field_name="number",
            raw_goldsky_pipeline_expr="block_number",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(block_number, 'Int64') AS block_number",
        ),
        Column(
            field_id=7,
            name="block_hash",
            field_type=StringType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getBlockByNumber,
            json_rpc_field_name="block_hash",
            raw_goldsky_pipeline_expr="block_hash",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="block_hash",
        ),
        # Transaction
        Column(
            field_id=8,
            name="hash",
            field_type=StringType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="hash",
            raw_goldsky_pipeline_expr="hash",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="hash",
        ),
        Column(
            field_id=9,
            name="nonce",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="nonce",
            raw_goldsky_pipeline_expr="nonce",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(nonce, 'Int64') AS nonce",
        ),
        Column(
            field_id=10,
            name="transaction_index",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="hash",
            raw_goldsky_pipeline_expr="transaction_index",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(transaction_index, 'Int64') AS transaction_index",
        ),
        Column(
            field_id=11,
            name="from_address",
            field_type=StringType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="from",
            raw_goldsky_pipeline_expr="from_address",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="from_address",
        ),
        Column(
            field_id=12,
            name="to_address",
            field_type=StringType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="to",
            raw_goldsky_pipeline_expr="to_address",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="to_address",
        ),
        Column(
            field_id=13,
            name="value",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="value",
            raw_goldsky_pipeline_expr="value",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCastOrNull(value, 'Int64') AS value",
            doc="Lossy value downcasted to Int64 to be compatible with BigQuery data types.",
        ),
        Column(
            field_id=14,
            name="value_lossless",
            field_type=StringType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="value",
            raw_goldsky_pipeline_expr="value",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="cast(value, 'String') AS value_lossless",
        ),
        Column(
            field_id=15,
            name="gas",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="gas",
            raw_goldsky_pipeline_expr="gas",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(gas, 'Int64') AS gas",
        ),
        Column(
            field_id=16,
            name="gas_price",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="gasPrice",
            raw_goldsky_pipeline_expr="gas_price",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(gas_price, 'Int64') AS gas_price",
        ),
        Column(
            field_id=17,
            name="input",
            field_type=StringType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="input",
            raw_goldsky_pipeline_expr="input",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="input",
        ),
        Column(
            field_id=18,
            name="transaction_type",
            field_type=IntegerType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="type",
            raw_goldsky_pipeline_expr="transaction_type",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(transaction_type, 'Int32') AS transaction_type",
        ),
        Column(
            field_id=19,
            name="max_fee_per_gas",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="maxFeePerGas",  # (aka. GasFeeCap)
            raw_goldsky_pipeline_expr="max_fee_per_gas",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(max_fee_per_gas, 'Int64') AS max_fee_per_gas",
        ),
        Column(
            field_id=20,
            name="max_priority_fee_per_gas",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="maxPriorityFeePerGas",  # (aka. GasTipCap)
            raw_goldsky_pipeline_expr="max_priority_fee_per_gas",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(max_priority_fee_per_gas, 'Int64') AS max_priority_fee_per_gas",
        ),
        Column(
            field_id=21,
            name="blob_versioned_hashes",
            field_type=ListType(element_id=1, element_type=StringType(), element_required=True),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="blobVersionedHashes",
            doc="a set of hash outputs from the blobs in the transaction",
            raw_goldsky_pipeline_expr=None,
            raw_goldsky_pipeline_type=None,
            op_analytics_clickhouse_expr=None,
        ),
        Column(
            field_id=22,
            name="max_fee_per_blob_gas",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionByHash,
            json_rpc_field_name="maxFeePerBlobGas",
            raw_goldsky_pipeline_expr=None,
            raw_goldsky_pipeline_type=None,
            op_analytics_clickhouse_expr=None,
        ),
        # Receipt
        Column(
            field_id=23,
            name="receipt_cumulative_gas_used",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="cumulativeGasUsed",
            raw_goldsky_pipeline_expr="receipt_cumulative_gas_used",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(receipt_cumulative_gas_used, 'Int64') AS receipt_cumulative_gas_used",
        ),
        Column(
            field_id=24,
            name="receipt_gas_used",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="gasUsed",
            raw_goldsky_pipeline_expr="receipt_gas_used",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(receipt_gas_used, 'Int64') AS receipt_gas_used",
        ),
        Column(
            field_id=25,
            name="receipt_contract_address",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="contractAddress",
            raw_goldsky_pipeline_expr="receipt_contract_address",
            raw_goldsky_pipeline_type="string",
            op_analytics_clickhouse_expr="receipt_contract_address",
        ),
        Column(
            field_id=26,
            name="receipt_status",
            field_type=IntegerType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="status",
            raw_goldsky_pipeline_expr="receipt_status",
            raw_goldsky_pipeline_type="long",
            op_analytics_clickhouse_expr="accurateCast(receipt_status, 'Int32') AS receipt_status",
        ),
        Column(
            field_id=27,
            name="receipt_effective_gas_price",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="effectiveGasPrice",
            raw_goldsky_pipeline_expr="receipt_effective_gas_price",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(receipt_effective_gas_price, 'Int64') AS receipt_effective_gas_price",
        ),
        Column(
            field_id=28,
            name="receipt_root_hash",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="root",
            raw_goldsky_pipeline_expr=None,
            raw_goldsky_pipeline_type=None,
            op_analytics_clickhouse_expr=None,
        ),
        Column(
            field_id=29,
            name="receipt_l1_gas_price",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="l1GasPrice",
            raw_goldsky_pipeline_expr="receipt_l1_gas_price",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(receipt_l1_gas_price, 'Nullable(Int64)') AS receipt_l1_gas_price",
        ),
        Column(
            field_id=30,
            name="receipt_l1_gas_used",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="l1GasUsed",
            raw_goldsky_pipeline_expr="receipt_l1_gas_used",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(receipt_l1_gas_used, 'Nullable(Int64)') AS receipt_l1_gas_used",
        ),
        Column(
            field_id=31,
            name="receipt_l1_fee",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="l1Fee",
            raw_goldsky_pipeline_expr="receipt_l1_fee",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(receipt_l1_fee, 'Nullable(Int64)') receipt_l1_fee",
        ),
        Column(
            field_id=32,
            name="receipt_l1_fee_scalar",
            field_type=DoubleType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="l1FeeScalar",
            doc="This field was removed in Ecotone.",
            raw_goldsky_pipeline_expr="receipt_l1_fee_scalar",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="receipt_l1_fee_scalar",
        ),
        Column(
            field_id=33,
            name="receipt_l1_blob_base_fee",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="l1BlobBaseFee",
            doc="This field was added in Ecotone.",
            raw_goldsky_pipeline_expr="receipt_l1_blob_base_fee",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(receipt_l1_blob_base_fee, 'Nullable(Int64)') AS receipt_l1_blob_base_fee",
        ),
        Column(
            field_id=34,
            name="receipt_l1_blob_base_fee_scalar",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="l1BlobBaseFeeScalar",
            doc="This field was added in Ecotone.",
            raw_goldsky_pipeline_expr="receipt_l1_blob_base_fee_scalar",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(receipt_l1_blob_base_fee_scalar, 'Nullable(Int64)') AS receipt_l1_blob_base_fee_scalar",
        ),
        Column(
            field_id=35,
            name="receipt_l1_base_fee_scalar",
            field_type=LongType(),
            required=True,
            json_rpc_method=JsonRPCMethod.eth_getTransactionReceipt,
            json_rpc_field_name="l1BaseFeeScalar",
            doc="This field was added in Ecotone.",
            raw_goldsky_pipeline_expr="receipt_l1_base_fee_scalar",
            raw_goldsky_pipeline_type="decimal",
            op_analytics_clickhouse_expr="accurateCast(receipt_l1_base_fee_scalar, 'Nullable(Int64)') AS receipt_l1_base_fee_scalar",
        ),
    ],
)
