import json

from op_analytics.datapipeline.models.code.account_abstraction.decoders import (
    inner_handle_op_decoder,
)

# https://basescan.org/tx/0xa6afb687ed95e708b6086b8fd864cd56bd46746c9850e943a035c4863f88fbed
trace_input_v0_6_0 = "0x1d73275600000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000da02730a01bfa6bef7ab08ee6cf2df924dc22c4c000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000002ebb8000000000000000000000000000000000000000000000000000000000001cddb0000000000000000000000000000000000000000000000000000000000017e6d000000000000000000000000000000f6faeda8f7bfa1a8589b4b6e2d71c37592000000000000000000000000000000000000000000000000000000000060ad31000000000000000000000000000000000000000000000000000000000010c8e0ae38f634347b7f2a56c3f9b8dae1d393b926997af86d30d253df27d5de4da5ba000000000000000000000000000000000000000000000000000003b60a3383d600000000000000000000000000000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000024598000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002445c1c6dcd000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000066c6c6fca286f48a7f4e989b7198c26caf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000184fec93e4900000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000008d3d00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000275fa99450bd44b2a69d1d9d002a253bac66c787000000000000000000000000000000000000000000000000000000000060ad31000000000000000000000000000000000000000000000000000000000010c8e0"

# https://basescan.org/tx/0x7567abffc05821a221c1c48e9a70b1dc6d807aa64f70baa41a4024464ece3864
trace_input_v0_7_0 = "0x0042dc5300000000000000000000000000000000000000000000000000000000000002000000000000000000000000001a38889b6a9971968347f33e3a4fc1af0715b3d90000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000008647000000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000249f000000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000011170000000000000000000000000592e1224d203be4214b15e205f6081fbbacfcd2d00000000000000000000000000000000000000000000000000000000004eb0ec00000000000000000000000000000000000000000000000000000000000f4240d749754ba43604d048d33a4bb3f0dc47207cf101af5e1c3b9200722a873195030000000000000000000000000000000000000000000000000000048cb5800ac0000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000879db0000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000014434fcd5be0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003f14920c99beb920afa163031c4e47a3e03b3e4a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000c800f68e363f14986a6ad0ce40dd5324097a219c00000000000000000000000000000000000000000000000000000000000003e8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000010a090000000000000000000000001a38889b6a9971968347f33e3a4fc1af0715b3d9"


def test_inner_handle_op():
    decoder = inner_handle_op_decoder()

    # The same decoder can handle both v6 and v7.
    actual = [
        decoder.decode(trace_input_v0_6_0),
        decoder.decode(trace_input_v0_7_0),
    ]

    for val in actual:
        val["op_info"] = json.loads(val["op_info"])

    assert actual == [
        {
            "decode_error": None,
            "opinfo_sender": "0xda02730a01bfa6bef7ab08ee6cf2df924dc22c4c",
            "opinfo_paymaster": "0x000000f6faeda8f7bfa1a8589b4b6e2d71c37592",
            "opinfo_userophash": "0xae38f634347b7f2a56c3f9b8dae1d393b926997af86d30d253df27d5de4da5ba",
            "opinfo": {
                "mUserOp": {
                    "nonce": "60",
                    "callGasLimit": "191416",
                    "verificationGasLimit": "118235",
                    "preVerificationGas": "97901",
                    "maxFeePerGas": "6335793",
                    "maxPriorityFeePerGas": "1100000",
                },
                "prefund": "4080390079446",
                "contextOffset": "1312",
                "preOpGas": "148888",
            },
            "calldata": "0x5c1c6dcd000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000066c6c6fca286f48a7f4e989b7198c26caf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000184fec93e4900000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000008d3d00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "context": "0x000000000000000000000000275fa99450bd44b2a69d1d9d002a253bac66c787000000000000000000000000000000000000000000000000000000000060ad31000000000000000000000000000000000000000000000000000000000010c8e0",
        },
        {
            "decode_error": None,
            "op_info_sender": "0x1a38889b6a9971968347f33e3a4fc1af0715b3d9",
            "op_info_paymaster": "0x592e1224d203be4214b15e205f6081fbbacfcd2d",
            "op_info_user_op_hash": "0xd749754ba43604d048d33a4bb3f0dc47207cf101af5e1c3b9200722a87319503",
            "op_info": {
                "mUserOp": {
                    "nonce": "8",
                    "verificationGasLimit": "550000",
                    "callGasLimit": "100000",
                    "paymasterVerificationGasLimit": "150000",
                    "paymasterPostOpGasLimit": "100000",
                    "preVerificationGas": "70000",
                    "maxFeePerGas": "5157100",
                    "maxPriorityFeePerGas": "1000000",
                },
                "prefund": "5002387000000",
                "contextOffset": "1280",
                "preOpGas": "555483",
            },
            "calldata": "0x34fcd5be0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003f14920c99beb920afa163031c4e47a3e03b3e4a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000c800f68e363f14986a6ad0ce40dd5324097a219c00000000000000000000000000000000000000000000000000000000000003e800000000000000000000000000000000000000000000000000000000",
            "context": "0x0000000000000000000000000000000000000000000000000000000000010a090000000000000000000000001a38889b6a9971968347f33e3a4fc1af0715b3d9",
        },
    ]
