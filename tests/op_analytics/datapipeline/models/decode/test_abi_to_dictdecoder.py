import statistics
import time

import pytest

from op_analytics.datapipeline.models.code.account_abstraction.abis import (
    INNER_HANDLE_OP_FUNCTION_ABI_v0_6_0,
    HANDLE_OPS_FUNCTION_ABI_v0_6_0,
    USER_OP_EVENT_ABI_v0_6_0,
)
from op_analytics.datapipeline.models.decode.abi_to_dictdecoder import (
    DictionaryDecoder,
)

# innerHandleOp
# https://basescan.org/tx/0xa6afb687ed95e708b6086b8fd864cd56bd46746c9850e943a035c4863f88fbed
trace_input_v0_6_0 = "0x1d73275600000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000da02730a01bfa6bef7ab08ee6cf2df924dc22c4c000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000002ebb8000000000000000000000000000000000000000000000000000000000001cddb0000000000000000000000000000000000000000000000000000000000017e6d000000000000000000000000000000f6faeda8f7bfa1a8589b4b6e2d71c37592000000000000000000000000000000000000000000000000000000000060ad31000000000000000000000000000000000000000000000000000000000010c8e0ae38f634347b7f2a56c3f9b8dae1d393b926997af86d30d253df27d5de4da5ba000000000000000000000000000000000000000000000000000003b60a3383d600000000000000000000000000000000000000000000000000000000000005200000000000000000000000000000000000000000000000000000000000024598000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000002445c1c6dcd000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000066c6c6fca286f48a7f4e989b7198c26caf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000184fec93e4900000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000008d3d00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000275fa99450bd44b2a69d1d9d002a253bac66c787000000000000000000000000000000000000000000000000000000000060ad31000000000000000000000000000000000000000000000000000000000010c8e0"

# innerHandleOp
# https://basescan.org/tx/0x7567abffc05821a221c1c48e9a70b1dc6d807aa64f70baa41a4024464ece3864
trace_input_v0_7_0 = "0x0042dc5300000000000000000000000000000000000000000000000000000000000002000000000000000000000000001a38889b6a9971968347f33e3a4fc1af0715b3d90000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000008647000000000000000000000000000000000000000000000000000000000000186a000000000000000000000000000000000000000000000000000000000000249f000000000000000000000000000000000000000000000000000000000000186a00000000000000000000000000000000000000000000000000000000000011170000000000000000000000000592e1224d203be4214b15e205f6081fbbacfcd2d00000000000000000000000000000000000000000000000000000000004eb0ec00000000000000000000000000000000000000000000000000000000000f4240d749754ba43604d048d33a4bb3f0dc47207cf101af5e1c3b9200722a873195030000000000000000000000000000000000000000000000000000048cb5800ac0000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000879db0000000000000000000000000000000000000000000000000000000000000380000000000000000000000000000000000000000000000000000000000000014434fcd5be0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000003f14920c99beb920afa163031c4e47a3e03b3e4a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000c800f68e363f14986a6ad0ce40dd5324097a219c00000000000000000000000000000000000000000000000000000000000003e8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000010a090000000000000000000000001a38889b6a9971968347f33e3a4fc1af0715b3d9"


# UserOperationEvent and handleOps (method_id=0x1fad948c) for an example v0_6_0 transaction
# https://basescan.org/tx/0x6fd49c93c750407c5d3a1336276af6d9e149f59f1e23a53e66dcd1ce558d432d
# The UserOperationEvent is for the last userOp at log_idx=185.
user_operation_event = "0x000000000000000000000000000000000000000000000000000000000000272c0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000001a10e02a096000000000000000000000000000000000000000000000000000000000002a002"
trace_input_handle_ops = "0x1fad948c0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000fbd85a0c200b286ef2d7a08306113669013c39da000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000005800000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000ee000000000000000000000000000000000000000000000000000000000000012a0000000000000000000000000f707327e5cb868b8f6a268268cb8c4b989bc933c0000000000000000000000000000000000000000000000000000000000000065000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000026d1b000000000000000000000000000000000000000000000000000000000001687a000000000000000000000000000000000000000000000000000000000001891c0000000000000000000000000000000000000000000000000000000000bbb35c00000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000204b61d27f6000000000000000000000000017405a2de0613e12cd3d7b67e691bfefc46debf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000164f3912026000000000000000000000000f707327e5cb868b8f6a268268cb8c4b989bc933c00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000066bfbaf0000000000000000000000000000000000000000000000000000000000000001ca0c5d7bfbf064345c0a8cd14619fe6448f4b2588720cfe59652542057ad5468661f92b013ef59329d8396195871a750fd95abfd46c5d569a75aa7f15ff4e3f8800000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000007fbff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000072a270ef92c1e11f1c1f95753c2e56801e8125fa83000066bfbaf1000000000000009896b200000a968163f0a57b4000000069f25cd342c7a2030593f2f10839c4d7000e0f7c142e91590bd838f72ac1218e608b1e37dffd6869e8087ac95404938a389eb1327962f0899bbf2d08cdc18aff1b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041a297b9e96d38fff46a3824c89fe2cddf168013ecd91d9f7f4d6caba619422eb37f9e9b828e5fd48b0a37d61e9a1e8496276ea2ed004ba18984437d21b6bdb61c1c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000e6750553bdb04ac7727580a92e0c55bf56a5fea90000000000000000000000000000000000000000000000000000000000000049000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000023a88000000000000000000000000000000000000000000000000000000000001687a00000000000000000000000000000000000000000000000000000000000185910000000000000000000000000000000000000000000000000000000000bb87c700000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a4b61d27f6000000000000000000000000017405a2de0613e12cd3d7b67e691bfefc46debf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104ebefad06000000000000000000000000e6750553bdb04ac7727580a92e0c55bf56a5fea900000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000066bfbaee000000000000000000000000000000000000000000000000000000000000001c7a64fe66e5834f498a6b612ebd798627135c184725e568e8028d29e94e3973220e88cfa7b5392bcf924d97b7e8dc03d4208a50b80ef8b5c27841aac0011c295b0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000072a270ef92c1e11f1c1f95753c2e56801e8125fa83000066bfbaef000000000000009896b200000a968163f0a57b400000008c25afa5b75dca4614de275da91ff0856686e5e8bb5ee9c5386368c3405e07ab3be80d7fa99f4d3b454f267369bee8ead0af0eaf53bd5295cdd8a1b919f162151b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000412b81de96dd82a5c0571f32bdebfc67b064a6390371a779fa6dd07c6a5f9ba14b408bf185468d888c1779d123e14fd067cdf316c4ec908658a0930af7032bd9c31b000000000000000000000000000000000000000000000000000000000000000000000000000000000000006596dc12fb72d086503e0697662a1dd311c355f00000000000000000000000000000000000000000000000000000000000000066000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000000000000000000000026d1b000000000000000000000000000000000000000000000000000000000001687a00000000000000000000000000000000000000000000000000000000000189180000000000000000000000000000000000000000000000000000000000bb87c700000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000204b61d27f6000000000000000000000000017405a2de0613e12cd3d7b67e691bfefc46debf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000164f39120260000000000000000000000006596dc12fb72d086503e0697662a1dd311c355f000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000066bfbaee000000000000000000000000000000000000000000000000000000000000001bf417ad71bd1359b07f52cb83081d6a3b14c9f970196ee1f1978d425bd5a35ef54bf5495036ce146b41bbdddedfaac7ea8dfa1923608231dc7ecec2b07bb7618c00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000008a3ed0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000072a270ef92c1e11f1c1f95753c2e56801e8125fa83000066bfbaef000000000000009896b200000a968163f0a57b4000000017854ebb22ed7e2236f707d0448d40078844882fd610b40ec6ad7d7b70ea2d325138261098ab8e5053bbe9740c0e91cf50be7b3cb78a97bb36a59630b35b62d61c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000417a581c7ed4c708c4ff03fb124d28b035758a60a2ba8aef3500ef9617279bb6fd54d08cf49fd0271ecefc7e457df5ce46058c44014416d05bcaee206bda8fb1bf1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000004cd17e2e2e7b4e02632bec9ace6994b94988dcb200000000000000000000000000000000000000000000000000000000000005d500000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000002298d000000000000000000000000000000000000000000000000000000000000aba7000000000000000000000000000000000000000000000000000000000000cf810000000000000000000000000000000000000000000000000000000000bb33fd00000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000164b61d27f600000000000000000000000080625310db240631a91f61659ccc550ea97617420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c429c911c90000000000000000000000004cd17e2e2e7b4e02632bec9ace6994b94988dcb20000000000000000000000000000000000000000000000000000000000013ef40000000000000000000000000000000000000000000000000000000066bfc69b000000000000000000000000000000000000000000000000000000000000001c0b7c7d4c9be7a0def8d5b817e5e3c025b1530c8e3e0b823be65f50df9a7bd99f318755f12b1736f74ac9b954b82d20eb51cba6155048715426494862e4fd488c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000418c2dfde4c74133a756b0335001bfaf4ebabc9d0b2d0c00f183a79150f2899c7f4e25131c6e13e1fbf713109dc9971073662fd349035f07fd244669fe2c3c84ab1c000000000000000000000000000000000000000000000000000000000000000000000000000000000000002585841e5131b64adce64a84fdd562cb80b6c402000000000000000000000000000000000000000000000000000000000000272c00000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000001d17d000000000000000000000000000000000000000000000000000000000000aba7000000000000000000000000000000000000000000000000000000000000cf780000000000000000000000000000000000000000000000000000000000bb33fd00000000000000000000000000000000000000000000000000000000000f42400000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000164b61d27f600000000000000000000000080625310db240631a91f61659ccc550ea97617420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c40471c4560000000000000000000000002585841e5131b64adce64a84fdd562cb80b6c402000000000000000000000000000000000000000000000000000000000000a9070000000000000000000000000000000000000000000000000000000066bfc6a1000000000000000000000000000000000000000000000000000000000000001b1c923648ce8c9b74cc02ce52e3dfa13a2e21e733c4b015f35bcd890da9a7aae17afe3bc2edd2c8a4e4dd5eab4d0a6a07f318854ab4efdc08446f0691aeb107fa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041cf4ef85c4ebcd0a659b82c4ab8fad88bfe670f8df704d8b627f27334580a1fcd59288a153db2a4958e16e3ad439f19d1ffaae8687cf25bc0e55760c75c3def811c00000000000000000000000000000000000000000000000000000000000000"


def test_inner_handle_op():
    decoder = DictionaryDecoder.of(INNER_HANDLE_OP_FUNCTION_ABI_v0_6_0)

    actual = decoder.decode_function(trace_input_v0_6_0)

    assert actual == {
        "callData": "0x5c1c6dcd000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000066c6c6fca286f48a7f4e989b7198c26caf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000184fec93e4900000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000008d3d00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "context": "0x000000000000000000000000275fa99450bd44b2a69d1d9d002a253bac66c787000000000000000000000000000000000000000000000000000000000060ad31000000000000000000000000000000000000000000000000000000000010c8e0",
        "opInfo": {
            "contextOffset": "1312",
            "mUserOp": {
                "callGasLimit": "191416",
                "maxFeePerGas": "6335793",
                "maxPriorityFeePerGas": "1100000",
                "nonce": "60",
                "paymaster": "0x000000f6faeda8f7bfa1a8589b4b6e2d71c37592",
                "preVerificationGas": "97901",
                "sender": "0xda02730a01bfa6bef7ab08ee6cf2df924dc22c4c",
                "verificationGasLimit": "118235",
            },
            "preOpGas": "148888",
            "prefund": "4080390079446",
            "userOpHash": "0xae38f634347b7f2a56c3f9b8dae1d393b926997af86d30d253df27d5de4da5ba",
        },
    }


@pytest.mark.skip
def test_performance():
    decoder = DictionaryDecoder.of(INNER_HANDLE_OP_FUNCTION_ABI_v0_6_0)

    # Run multiple iterations to get timing stats
    iterations = 10000
    timings = []

    for _ in range(iterations):
        start = time.perf_counter()
        decoder.decode_function_as_json(trace_input_v0_6_0)
        end = time.perf_counter()

        timings.append(end - start)

    # Calculate statistics
    avg_time = statistics.mean(timings)
    p95_time = statistics.quantiles(timings, n=20)[18]  # 95th percentile
    min_time = min(timings)
    max_time = max(timings)

    print(f"\nDecoder Performance Stats ({iterations:,} iterations):")
    print(f"Average time: {avg_time*1000:.2f}ms")
    print(f"95th percentile: {p95_time*1000:.2f}ms")
    print(f"Min time: {min_time*1000:.2f}ms")
    print(f"Max time: {max_time*1000:.2f}ms")


def test_handle_ops():
    decoder = DictionaryDecoder.of(HANDLE_OPS_FUNCTION_ABI_v0_6_0)
    actual = decoder.decode_function(trace_input_handle_ops)

    assert actual == {
        "ops": [
            {
                "sender": "0xf707327e5cb868b8f6a268268cb8c4b989bc933c",
                "nonce": "101",
                "initCode": "0x",
                "callData": "0xb61d27f6000000000000000000000000017405a2de0613e12cd3d7b67e691bfefc46debf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000164f3912026000000000000000000000000f707327e5cb868b8f6a268268cb8c4b989bc933c00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000066bfbaf0000000000000000000000000000000000000000000000000000000000000001ca0c5d7bfbf064345c0a8cd14619fe6448f4b2588720cfe59652542057ad5468661f92b013ef59329d8396195871a750fd95abfd46c5d569a75aa7f15ff4e3f8800000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000007fbff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                "callGasLimit": "159003",
                "verificationGasLimit": "92282",
                "preVerificationGas": "100636",
                "maxFeePerGas": "12301148",
                "maxPriorityFeePerGas": "1000000",
                "paymasterAndData": "0xa270ef92c1e11f1c1f95753c2e56801e8125fa83000066bfbaf1000000000000009896b200000a968163f0a57b4000000069f25cd342c7a2030593f2f10839c4d7000e0f7c142e91590bd838f72ac1218e608b1e37dffd6869e8087ac95404938a389eb1327962f0899bbf2d08cdc18aff1b",
                "signature": "0xa297b9e96d38fff46a3824c89fe2cddf168013ecd91d9f7f4d6caba619422eb37f9e9b828e5fd48b0a37d61e9a1e8496276ea2ed004ba18984437d21b6bdb61c1c",
            },
            {
                "sender": "0xe6750553bdb04ac7727580a92e0c55bf56a5fea9",
                "nonce": "73",
                "initCode": "0x",
                "callData": "0xb61d27f6000000000000000000000000017405a2de0613e12cd3d7b67e691bfefc46debf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104ebefad06000000000000000000000000e6750553bdb04ac7727580a92e0c55bf56a5fea900000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000066bfbaee000000000000000000000000000000000000000000000000000000000000001c7a64fe66e5834f498a6b612ebd798627135c184725e568e8028d29e94e3973220e88cfa7b5392bcf924d97b7e8dc03d4208a50b80ef8b5c27841aac0011c295b0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000",
                "callGasLimit": "146056",
                "verificationGasLimit": "92282",
                "preVerificationGas": "99729",
                "maxFeePerGas": "12289991",
                "maxPriorityFeePerGas": "1000000",
                "paymasterAndData": "0xa270ef92c1e11f1c1f95753c2e56801e8125fa83000066bfbaef000000000000009896b200000a968163f0a57b400000008c25afa5b75dca4614de275da91ff0856686e5e8bb5ee9c5386368c3405e07ab3be80d7fa99f4d3b454f267369bee8ead0af0eaf53bd5295cdd8a1b919f162151b",
                "signature": "0x2b81de96dd82a5c0571f32bdebfc67b064a6390371a779fa6dd07c6a5f9ba14b408bf185468d888c1779d123e14fd067cdf316c4ec908658a0930af7032bd9c31b",
            },
            {
                "sender": "0x6596dc12fb72d086503e0697662a1dd311c355f0",
                "nonce": "102",
                "initCode": "0x",
                "callData": "0xb61d27f6000000000000000000000000017405a2de0613e12cd3d7b67e691bfefc46debf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000164f39120260000000000000000000000006596dc12fb72d086503e0697662a1dd311c355f000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000066bfbaee000000000000000000000000000000000000000000000000000000000000001bf417ad71bd1359b07f52cb83081d6a3b14c9f970196ee1f1978d425bd5a35ef54bf5495036ce146b41bbdddedfaac7ea8dfa1923608231dc7ecec2b07bb7618c00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000008a3ed0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
                "callGasLimit": "159003",
                "verificationGasLimit": "92282",
                "preVerificationGas": "100632",
                "maxFeePerGas": "12289991",
                "maxPriorityFeePerGas": "1000000",
                "paymasterAndData": "0xa270ef92c1e11f1c1f95753c2e56801e8125fa83000066bfbaef000000000000009896b200000a968163f0a57b4000000017854ebb22ed7e2236f707d0448d40078844882fd610b40ec6ad7d7b70ea2d325138261098ab8e5053bbe9740c0e91cf50be7b3cb78a97bb36a59630b35b62d61c",
                "signature": "0x7a581c7ed4c708c4ff03fb124d28b035758a60a2ba8aef3500ef9617279bb6fd54d08cf49fd0271ecefc7e457df5ce46058c44014416d05bcaee206bda8fb1bf1c",
            },
            {
                "sender": "0x4cd17e2e2e7b4e02632bec9ace6994b94988dcb2",
                "nonce": "1493",
                "initCode": "0x",
                "callData": "0xb61d27f600000000000000000000000080625310db240631a91f61659ccc550ea97617420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c429c911c90000000000000000000000004cd17e2e2e7b4e02632bec9ace6994b94988dcb20000000000000000000000000000000000000000000000000000000000013ef40000000000000000000000000000000000000000000000000000000066bfc69b000000000000000000000000000000000000000000000000000000000000001c0b7c7d4c9be7a0def8d5b817e5e3c025b1530c8e3e0b823be65f50df9a7bd99f318755f12b1736f74ac9b954b82d20eb51cba6155048715426494862e4fd488c00000000000000000000000000000000000000000000000000000000",
                "callGasLimit": "141709",
                "verificationGasLimit": "43943",
                "preVerificationGas": "53121",
                "maxFeePerGas": "12268541",
                "maxPriorityFeePerGas": "1000000",
                "paymasterAndData": "0x",
                "signature": "0x8c2dfde4c74133a756b0335001bfaf4ebabc9d0b2d0c00f183a79150f2899c7f4e25131c6e13e1fbf713109dc9971073662fd349035f07fd244669fe2c3c84ab1c",
            },
            {
                "sender": "0x2585841e5131b64adce64a84fdd562cb80b6c402",
                "nonce": "10028",
                "initCode": "0x",
                "callData": "0xb61d27f600000000000000000000000080625310db240631a91f61659ccc550ea97617420000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000c40471c4560000000000000000000000002585841e5131b64adce64a84fdd562cb80b6c402000000000000000000000000000000000000000000000000000000000000a9070000000000000000000000000000000000000000000000000000000066bfc6a1000000000000000000000000000000000000000000000000000000000000001b1c923648ce8c9b74cc02ce52e3dfa13a2e21e733c4b015f35bcd890da9a7aae17afe3bc2edd2c8a4e4dd5eab4d0a6a07f318854ab4efdc08446f0691aeb107fa00000000000000000000000000000000000000000000000000000000",
                "callGasLimit": "119165",
                "verificationGasLimit": "43943",
                "preVerificationGas": "53112",
                "maxFeePerGas": "12268541",
                "maxPriorityFeePerGas": "1000000",
                "paymasterAndData": "0x",
                "signature": "0xcf4ef85c4ebcd0a659b82c4ab8fad88bfe670f8df704d8b627f27334580a1fcd59288a153db2a4958e16e3ad439f19d1ffaae8687cf25bc0e55760c75c3def811c",
            },
        ],
        "beneficiary": "0xfbd85a0c200b286ef2d7a08306113669013c39da",
    }


def test_user_operation_event():
    decoder = DictionaryDecoder.of(USER_OP_EVENT_ABI_v0_6_0)
    actual = decoder.decode_event(user_operation_event)

    assert actual == {
        "nonce": "10028",
        "success": True,
        "actualGasCost": "1791236415638",
        "actualGasUsed": "172034",
    }
