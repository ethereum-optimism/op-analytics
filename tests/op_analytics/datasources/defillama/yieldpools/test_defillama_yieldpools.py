import datetime

from op_analytics.datasources.defillama.yieldpools.metadata import YieldPoolsMetadata
from op_analytics.datasources.defillama.yieldpools.yieldpool import YieldPool

METADATA_RESPONSE = [
    {
        "chain": "Ethereum",
        "project": "lido",
        "symbol": "STETH",
        "tvlUsd": 25583811736,
        "apyBase": 2.722,
        "apyReward": None,
        "apy": 2.722,
        "rewardTokens": None,
        "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
        "apyPct1D": -0.063,
        "apyPct7D": -0.234,
        "apyPct30D": -0.706,
        "stablecoin": False,
        "ilRisk": "no",
        "exposure": "single",
        "predictions": {
            "predictedClass": "Stable/Up",
            "predictedProbability": 75,
            "binnedConfidence": 3,
        },
        "poolMeta": None,
        "mu": 3.90421,
        "sigma": 0.0522,
        "count": 996,
        "outlier": False,
        "underlyingTokens": ["0x0000000000000000000000000000000000000000"],
        "il7d": None,
        "apyBase7d": None,
        "apyMean30d": 3.21431,
        "volumeUsd1d": None,
        "volumeUsd7d": None,
        "apyBaseInception": None,
    },
    {
        "chain": "Ethereum",
        "project": "ether.fi-stake",
        "symbol": "WEETH",
        "tvlUsd": 5518237771,
        "apyBase": 3.30474,
        "apyReward": 0.71204,
        "apy": 4.01678,
        "rewardTokens": ["0x8F08B70456eb22f6109F57b8fafE862ED28E6040"],
        "pool": "46bd2bdf-6d92-4066-b482-e885ee172264",
        "apyPct1D": 0.44219,
        "apyPct7D": 1.33144,
        "apyPct30D": 1.39961,
        "stablecoin": False,
        "ilRisk": "no",
        "exposure": "single",
        "predictions": {
            "predictedClass": "Stable/Up",
            "predictedProbability": 54,
            "binnedConfidence": 1,
        },
        "poolMeta": None,
        "mu": 3.17796,
        "sigma": 0.04416,
        "count": 261,
        "outlier": False,
        "underlyingTokens": ["0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2"],
        "il7d": None,
        "apyBase7d": 2.84167,
        "apyMean30d": 3.70565,
        "volumeUsd1d": None,
        "volumeUsd7d": None,
        "apyBaseInception": None,
    },
]

POOL_ID = "747c1d2a-c668-4682-b9f9-296708a3dd90"

YIELDPOOL_RESPONSE = [
    {
        "timestamp": "2022-05-03T00:00:00.000Z",
        "tvlUsd": 11074372760,
        "apy": 3.6,
        "apyBase": 3.6,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
    {
        "timestamp": "2022-05-04T00:00:00.000Z",
        "tvlUsd": 11744709791,
        "apy": 3.6,
        "apyBase": 3.6,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
    {
        "timestamp": "2022-05-05T00:00:00.000Z",
        "tvlUsd": 11008298772,
        "apy": 3.6,
        "apyBase": 3.6,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
    {
        "timestamp": "2022-05-06T00:00:00.000Z",
        "tvlUsd": 10974211995,
        "apy": 3.5,
        "apyBase": 3.5,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
    {
        "timestamp": "2022-05-07T00:00:00.000Z",
        "tvlUsd": 10736517627,
        "apy": 3.5,
        "apyBase": 3.5,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
    {
        "timestamp": "2022-05-08T00:00:00.000Z",
        "tvlUsd": 10375445969,
        "apy": 3.6,
        "apyBase": 3.6,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
    {
        "timestamp": "2022-05-09T00:00:00.000Z",
        "tvlUsd": 9406769875,
        "apy": 3.5,
        "apyBase": 3.5,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
    {
        "timestamp": "2022-05-10T00:00:00.000Z",
        "tvlUsd": 9506069560,
        "apy": 3.6,
        "apyBase": 3.6,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
    {
        "timestamp": "2022-05-11T00:00:00.000Z",
        "tvlUsd": 8714550420,
        "apy": 3.6,
        "apyBase": 3.6,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
    {
        "timestamp": "2022-05-12T00:00:00.000Z",
        "tvlUsd": 7857787286,
        "apy": 3.6,
        "apyBase": 3.6,
        "apyReward": None,
        "il7d": None,
        "apyBase7d": None,
    },
]


def test_construct_dataframes():
    # To get test data:
    # YieldPoolsMetadata.fetch(new_session(), process_dt=date(2025, 2, 20))

    metadata = YieldPoolsMetadata.of(METADATA_RESPONSE, process_dt=datetime.date(2025, 2, 20))

    single = metadata.get_single_pool_metadata(POOL_ID)
    assert single == {
        "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
        "protocol_slug": "lido",
        "chain": "Ethereum",
        "symbol": "STETH",
        "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
        "reward_tokens": None,
        "il_risk": "no",
        "is_stablecoin": False,
        "exposure": "single",
        "pool_meta": "main_pool",
    }

    actual = metadata.df.to_dicts()
    assert actual == [
        {
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "dt": datetime.date(2025, 2, 20),
        },
        {
            "pool": "46bd2bdf-6d92-4066-b482-e885ee172264",
            "protocol_slug": "ether.fi-stake",
            "chain": "Ethereum",
            "symbol": "WEETH",
            "underlying_tokens": ["0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2"],
            "reward_tokens": ["0x8F08B70456eb22f6109F57b8fafE862ED28E6040"],
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "dt": datetime.date(2025, 2, 20),
        },
    ]

    # Now go ahead and test the data for a single yield pool
    # from op_analytics.coreutils.request import new_session
    # YieldPool.fetch(new_session(), POOL_ID, pools_metadata=metadata)

    yp = YieldPool.of(data=YIELDPOOL_RESPONSE, pool_id=POOL_ID, pools_metadata=metadata)
    actual_yp = yp.df.to_dicts()
    assert actual_yp == [
        {
            "dt": "2022-05-03",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 11074372760.0,
            "apy": 3.6,
            "apy_base": 3.6,
            "apy_reward": 0.0,
        },
        {
            "dt": "2022-05-04",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 11744709791.0,
            "apy": 3.6,
            "apy_base": 3.6,
            "apy_reward": 0.0,
        },
        {
            "dt": "2022-05-05",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 11008298772.0,
            "apy": 3.6,
            "apy_base": 3.6,
            "apy_reward": 0.0,
        },
        {
            "dt": "2022-05-06",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 10974211995.0,
            "apy": 3.5,
            "apy_base": 3.5,
            "apy_reward": 0.0,
        },
        {
            "dt": "2022-05-07",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 10736517627.0,
            "apy": 3.5,
            "apy_base": 3.5,
            "apy_reward": 0.0,
        },
        {
            "dt": "2022-05-08",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 10375445969.0,
            "apy": 3.6,
            "apy_base": 3.6,
            "apy_reward": 0.0,
        },
        {
            "dt": "2022-05-09",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 9406769875.0,
            "apy": 3.5,
            "apy_base": 3.5,
            "apy_reward": 0.0,
        },
        {
            "dt": "2022-05-10",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 9506069560.0,
            "apy": 3.6,
            "apy_base": 3.6,
            "apy_reward": 0.0,
        },
        {
            "dt": "2022-05-11",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 8714550420.0,
            "apy": 3.6,
            "apy_base": 3.6,
            "apy_reward": 0.0,
        },
        {
            "dt": "2022-05-12",
            "pool": "747c1d2a-c668-4682-b9f9-296708a3dd90",
            "protocol_slug": "lido",
            "chain": "Ethereum",
            "symbol": "STETH",
            "underlying_tokens": ["0x0000000000000000000000000000000000000000"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "pool_meta": "main_pool",
            "tvl_usd": 7857787286.0,
            "apy": 3.6,
            "apy_base": 3.6,
            "apy_reward": 0.0,
        },
    ]
