import datetime

import numpy as np

from op_analytics.datasources.defillama.lendborrowpools.metadata import LendBorrowPoolsMetadata
from op_analytics.datasources.defillama.lendborrowpools.lendborrowpool import LendBorrowPool

METADATA_RESPONSE = [
    {
        "chain": "Ethereum",
        "project": "aave-v3",
        "symbol": "WETH",
        "tvlUsd": 646539064,
        "apyBase": 1.93991,
        "apyReward": None,
        "apy": 1.93991,
        "rewardTokens": None,
        "pool": "e880e828-ca59-4ec6-8d4f-27182a4dc23d",
        "apyPct1D": -0.04055,
        "apyPct7D": 0.15848,
        "apyPct30D": -0.04657,
        "stablecoin": False,
        "ilRisk": "no",
        "exposure": "single",
        "predictions": {
            "predictedClass": "Stable/Up",
            "predictedProbability": 89,
            "binnedConfidence": 3,
        },
        "poolMeta": None,
        "mu": 1.87468,
        "sigma": 0.01902,
        "count": 748,
        "outlier": False,
        "underlyingTokens": ["0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"],
        "il7d": None,
        "apyBase7d": None,
        "apyMean30d": 1.95046,
        "volumeUsd1d": None,
        "volumeUsd7d": None,
        "apyBaseInception": None,
        "apyBaseBorrow": 2.61663,
        "apyRewardBorrow": None,
        "totalSupplyUsd": 5059273152,
        "totalBorrowUsd": 4412734088,
        "debtCeilingUsd": None,
        "ltv": 0.805,
        "borrowable": True,
        "mintedCoin": None,
        "borrowFactor": None,
    },
    {
        "chain": "Ethereum",
        "project": "aave-v3",
        "symbol": "USDT",
        "tvlUsd": 1146160118,
        "apyBase": 4.15751,
        "apyReward": None,
        "apy": 4.15751,
        "rewardTokens": None,
        "pool": "f981a304-bb6c-45b8-b0c5-fd2f515ad23a",
        "apyPct1D": 0.03543,
        "apyPct7D": 0.40017,
        "apyPct30D": -2.32155,
        "stablecoin": True,
        "ilRisk": "no",
        "exposure": "single",
        "predictions": {
            "predictedClass": "Down",
            "predictedProbability": 55.00000000000001,
            "binnedConfidence": 1,
        },
        "poolMeta": None,
        "mu": 5.25875,
        "sigma": 0.2034,
        "count": 738,
        "outlier": False,
        "underlyingTokens": ["0xdAC17F958D2ee523a2206206994597C13D831ec7"],
        "il7d": None,
        "apyBase7d": None,
        "apyMean30d": 5.21359,
        "volumeUsd1d": None,
        "volumeUsd7d": None,
        "apyBaseInception": None,
        "apyBaseBorrow": 6.90658,
        "apyRewardBorrow": None,
        "totalSupplyUsd": 3461050613,
        "totalBorrowUsd": 2314890494,
        "debtCeilingUsd": None,
        "ltv": 0.75,
        "borrowable": True,
        "mintedCoin": None,
        "borrowFactor": None,
    },
    {
        "chain": "Ethereum",
        "project": "aave-v3",
        "symbol": "WBTC",
        "tvlUsd": 3111848276,
        "apyBase": 0.0178,
        "apyReward": None,
        "apy": 0.0178,
        "rewardTokens": None,
        "pool": "7e382157-b1bc-406d-b17b-facba43b716e",
        "apyPct1D": -0.00055,
        "apyPct7D": 0.00046,
        "apyPct30D": -0.00124,
        "stablecoin": False,
        "ilRisk": "no",
        "exposure": "single",
        "predictions": {
            "predictedClass": "Stable/Up",
            "predictedProbability": 83,
            "binnedConfidence": 3,
        },
        "poolMeta": None,
        "mu": 0.10803,
        "sigma": 0.00673,
        "count": 748,
        "outlier": False,
        "underlyingTokens": ["0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599"],
        "il7d": None,
        "apyBase7d": None,
        "apyMean30d": 0.01855,
        "volumeUsd1d": None,
        "volumeUsd7d": None,
        "apyBaseInception": None,
        "apyBaseBorrow": 0.42188,
        "apyRewardBorrow": None,
        "totalSupplyUsd": 3398604649,
        "totalBorrowUsd": 286756373,
        "debtCeilingUsd": None,
        "ltv": 0.73,
        "borrowable": True,
        "mintedCoin": None,
        "borrowFactor": None,
    },
]

POOL_ID = "e880e828-ca59-4ec6-8d4f-27182a4dc23d"

LEND_BORROW_POOL_RESPONSE = [
    {
        "timestamp": "2023-02-06T23:01:24.670Z",
        "totalSupplyUsd": 60767153,
        "totalBorrowUsd": 33150230,
        "debtCeilingUsd": None,
        "apyBase": 1.66533,
        "apyReward": None,
        "apyBaseBorrow": 3.59132,
        "apyRewardBorrow": None,
    },
    {
        "timestamp": "2023-02-07T23:01:03.756Z",
        "totalSupplyUsd": 62521344,
        "totalBorrowUsd": 30487114,
        "debtCeilingUsd": None,
        "apyBase": 1.3746,
        "apyReward": None,
        "apyBaseBorrow": 3.31631,
        "apyRewardBorrow": None,
    },
    {
        "timestamp": "2023-02-08T23:01:03.305Z",
        "totalSupplyUsd": 72536324,
        "totalBorrowUsd": 39327376,
        "debtCeilingUsd": None,
        "apyBase": 1.64777,
        "apyReward": None,
        "apyBaseBorrow": 3.57541,
        "apyRewardBorrow": None,
    },
    {
        "timestamp": "2023-02-09T23:01:04.532Z",
        "totalSupplyUsd": 62109112,
        "totalBorrowUsd": 41194048,
        "debtCeilingUsd": None,
        "apyBase": 2.33998,
        "apyReward": None,
        "apyBaseBorrow": 4.15053,
        "apyRewardBorrow": None,
    },
]


def test_construct_dataframes():
    # To get test data:
    # from datetime import date
    # LendBorrowPoolsMetadata.fetch(process_dt=date(2025, 2, 20))

    metadata = LendBorrowPoolsMetadata.of(METADATA_RESPONSE, process_dt=datetime.date(2025, 2, 20))

    single = metadata.get_single_pool_metadata(POOL_ID)

    borrow_factor = single.pop("borrow_factor")
    assert np.isnan(borrow_factor)

    assert single == {
        "pool": "e880e828-ca59-4ec6-8d4f-27182a4dc23d",
        "protocol_slug": "aave-v3",
        "chain": "Ethereum",
        "symbol": "WETH",
        "underlying_tokens": ["0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"],
        "reward_tokens": None,
        "il_risk": "no",
        "is_stablecoin": False,
        "exposure": "single",
        "borrowable": True,
        "minted_coin": None,
        # "borrow_factor": float("nan"),
        "pool_meta": "main_pool",
    }

    actual = metadata.df.to_dicts()
    for row in actual:
        assert np.isnan(row["borrow_factor"])
        row["borrow_factor"] = None

    assert actual == [
        {
            "pool": "e880e828-ca59-4ec6-8d4f-27182a4dc23d",
            "protocol_slug": "aave-v3",
            "chain": "Ethereum",
            "symbol": "WETH",
            "underlying_tokens": ["0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "borrowable": True,
            "minted_coin": None,
            "borrow_factor": None,
            "pool_meta": "main_pool",
            "dt": datetime.date(2025, 2, 20),
        },
        {
            "pool": "f981a304-bb6c-45b8-b0c5-fd2f515ad23a",
            "protocol_slug": "aave-v3",
            "chain": "Ethereum",
            "symbol": "USDT",
            "underlying_tokens": ["0xdAC17F958D2ee523a2206206994597C13D831ec7"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": True,
            "exposure": "single",
            "borrowable": True,
            "minted_coin": None,
            "borrow_factor": None,
            "pool_meta": "main_pool",
            "dt": datetime.date(2025, 2, 20),
        },
        {
            "pool": "7e382157-b1bc-406d-b17b-facba43b716e",
            "protocol_slug": "aave-v3",
            "chain": "Ethereum",
            "symbol": "WBTC",
            "underlying_tokens": ["0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "borrowable": True,
            "minted_coin": None,
            "borrow_factor": None,
            "pool_meta": "main_pool",
            "dt": datetime.date(2025, 2, 20),
        },
    ]

    # Now go ahead and test the data for a single yield pool
    # LendBorrowPool.fetch(pool_id=POOL_ID, metadata=metadata)

    pool = LendBorrowPool.of(data=LEND_BORROW_POOL_RESPONSE, pool_id=POOL_ID, metadata=metadata)
    actual_pool = pool.df.to_dicts()

    assert actual_pool == [
        {
            "dt": "2023-02-06",
            "pool": "e880e828-ca59-4ec6-8d4f-27182a4dc23d",
            "protocol_slug": "aave-v3",
            "chain": "Ethereum",
            "symbol": "WETH",
            "underlying_tokens": ["0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "borrowable": True,
            "minted_coin": None,
            "borrow_factor": None,
            "pool_meta": "main_pool",
            "total_supply_usd": 60767153,
            "total_borrow_usd": 33150230,
            "debt_ceiling_usd": 0,
            "apy_base": 1.66533,
            "apy_reward": 0.0,
            "apy_base_borrow": 3.59132,
            "apy_reward_borrow": 0.0,
        },
        {
            "dt": "2023-02-07",
            "pool": "e880e828-ca59-4ec6-8d4f-27182a4dc23d",
            "protocol_slug": "aave-v3",
            "chain": "Ethereum",
            "symbol": "WETH",
            "underlying_tokens": ["0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "borrowable": True,
            "minted_coin": None,
            "borrow_factor": None,
            "pool_meta": "main_pool",
            "total_supply_usd": 62521344,
            "total_borrow_usd": 30487114,
            "debt_ceiling_usd": 0,
            "apy_base": 1.3746,
            "apy_reward": 0.0,
            "apy_base_borrow": 3.31631,
            "apy_reward_borrow": 0.0,
        },
        {
            "dt": "2023-02-08",
            "pool": "e880e828-ca59-4ec6-8d4f-27182a4dc23d",
            "protocol_slug": "aave-v3",
            "chain": "Ethereum",
            "symbol": "WETH",
            "underlying_tokens": ["0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "borrowable": True,
            "minted_coin": None,
            "borrow_factor": None,
            "pool_meta": "main_pool",
            "total_supply_usd": 72536324,
            "total_borrow_usd": 39327376,
            "debt_ceiling_usd": 0,
            "apy_base": 1.64777,
            "apy_reward": 0.0,
            "apy_base_borrow": 3.57541,
            "apy_reward_borrow": 0.0,
        },
        {
            "dt": "2023-02-09",
            "pool": "e880e828-ca59-4ec6-8d4f-27182a4dc23d",
            "protocol_slug": "aave-v3",
            "chain": "Ethereum",
            "symbol": "WETH",
            "underlying_tokens": ["0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2"],
            "reward_tokens": None,
            "il_risk": "no",
            "is_stablecoin": False,
            "exposure": "single",
            "borrowable": True,
            "minted_coin": None,
            "borrow_factor": None,
            "pool_meta": "main_pool",
            "total_supply_usd": 62109112,
            "total_borrow_usd": 41194048,
            "debt_ceiling_usd": 0,
            "apy_base": 2.33998,
            "apy_reward": 0.0,
            "apy_base_borrow": 4.15053,
            "apy_reward_borrow": 0.0,
        },
    ]
