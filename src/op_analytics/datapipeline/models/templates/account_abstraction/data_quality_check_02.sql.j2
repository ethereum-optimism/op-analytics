WITH

traces AS (
  SELECT
    block_number
    , transaction_hash
    , innerhandleop_opinfo_sender
    , matched_userop_sender
    , matched_userop_trace_address
    , is_from_matched_userop_sender
    , from_address
    , trace_address
  FROM account_abstraction__enriched_entrypoint_traces
  WHERE innerhandleop_opinfo_sender IS NOT NULL
)


-- Checks that when we flag something as "is_from_matched_userop_sender" the
-- "matched_userop_sender" and "from_address" must match, and also the trace
-- address should be a subtrace of the "matched_userop_trace_address".
SELECT
  'Unexpedted result on matched userop' AS error
  , t.block_number
  , t.transaction_hash
  , t.matched_userop_sender
  , t.from_address
FROM traces AS t
WHERE
  t.is_from_matched_userop_sender
  AND (
    t.matched_userop_sender != t.from_address
    OR NOT starts_with(t.trace_address, t.matched_userop_trace_address)
  )