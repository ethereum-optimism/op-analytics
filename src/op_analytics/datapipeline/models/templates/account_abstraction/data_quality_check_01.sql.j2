WITH

uops AS (
  SELECT
    block_number
    , transaction_hash
    , log_index
    , sender
  FROM account_abstraction__useroperationevent_logs
)

, traces AS (
  SELECT
    block_number
    , transaction_hash
    , innerhandleop_opinfo_sender
    , matched_userop_sender
    , is_from_matched_userop_sender
    , from_address
  FROM account_abstraction__enriched_entrypoint_traces
  WHERE innerhandleop_opinfo_sender IS NOT NULL
)

-- Checks that we see the same UserOps on the events and the traces.
SELECT
  'Unsatisfied JOIN for UserOperationEvent <> EntryPoint traces' AS error
  , u.block_number
  , u.transaction_hash
  , u.log_index
  , u.sender
  , t.innerhandleop_opinfo_sender
FROM uops AS u
FULL OUTER JOIN traces AS t
  ON
    u.block_number = t.block_number
    AND u.transaction_hash = t.transaction_hash
    AND u.sender = t.innerhandleop_opinfo_sender
WHERE
  u.sender IS NULL
  OR t.innerhandleop_opinfo_sender IS NULL
